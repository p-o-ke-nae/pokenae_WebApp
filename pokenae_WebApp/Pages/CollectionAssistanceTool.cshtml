
@page
@model pokenae_WebApp.Pages.CollectionAssistanceToolModel

<h3>Collection Assistance Tool</h3>

@if (Model.Columns == null)
{
    <p>Loading...</p>
}
else
{
    <div id="tablesContainer">
        <!-- テーブルのベースを作成 -->
        <table id="dataTable-template" style="border-collapse: collapse; width: 100%; margin-bottom: 20px; display: none;">
            <thead>
                <tr>
                    <th style="width: 100px; border: 1px solid black;">Image</th> <!-- Add a header for the image column -->
                    @foreach (var column in Model.Columns.Where(c => c.IsVisible))
                    {
                        <th style="width:@column.Width; border: 1px solid black;" data-width="@column.Width">@column.Header</th>
                    }
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <!-- モーダルのHTML -->
    <div id="imageModal" class="modal" style="display: none;">
        <span class="close" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="modalImage">
        <div id="modalInfo"></div>
        <button class="modal-nav" id="prevRecord" onclick="showPrevRecord()">Previous</button>
        <button class="modal-nav" id="nextRecord" onclick="showNextRecord()">Next</button>
    </div>
}

@section Scripts {
    <script>
        const columnIndices = @Html.Raw(Json.Serialize(Model.Columns.Where(c => c.IsVisible).Select(c => Model.Columns.IndexOf(c) + 3).ToList())); // +3 to skip the background color, item name, and image columns
        const hiddenColumnIndices = @Html.Raw(Json.Serialize(Model.Columns.Where(c => !c.IsVisible).Select(c => Model.Columns.IndexOf(c) + 3).ToList())); // +3 to skip the background color, item name, and image columns
        const columnHeaders = @Html.Raw(Json.Serialize(Model.Columns.Select(c => c.Header).ToList()));
        const columnWidths = @Html.Raw(Json.Serialize(Model.Columns.Where(c => c.IsVisible).Select(c => c.Width).ToList()));
        const spreadsheetId = "15vjM0HD16LGA7f9hLZC3DZIZaYnbOD41rPKI5gezh0c";
        const baseUrl = "https://script.google.com/macros/s/AKfycby0eB-AnstPy3b3m_ghF1rcZnNpUWqmuM4ZXWPY0-9n0iCqdoStfR0GBfgAIu3lMRP2/exec";

        let initialData = null;
        let tableTemplate = null;
        let currentRecordIndex = null;
        let currentTableName = null;
        let currentGroupedData = null;

        async function fetchData() {
            const url = `${baseUrl}?spreadsheetId=${spreadsheetId}&sheetName=Record`;
            const response = await fetch(url);
            if (!response.ok) {
                console.error("Failed to fetch data: " + response.statusText);
                return [];
            }
            const data = await response.json();
            return data.slice(1); // Skip the first row
        }

        function isDataDifferent(newData, oldData) {
            if (newData.length !== oldData.length) return true;
            for (let i = 0; i < newData.length; i++) {
                if (newData[i].length !== oldData[i].length) return true;
                for (let j = 0; j < newData[i].length; j++) {
                    if (newData[i][j] !== oldData[i][j]) return true;
                }
            }
            return false;
        }

        function createTable(groupedData) {
            const container = document.getElementById("tablesContainer");
            container.innerHTML = ""; // コンテナの内容をクリア
            currentGroupedData = groupedData; // 現在のグループ化されたデータを保存

            // 各アイテム名ごとにグループ化されたデータを処理
            Object.keys(groupedData).forEach(itemName => {
                // 項目名を表示する要素を作成
                const itemNameHeader = document.createElement("h4");
                itemNameHeader.innerText = itemName;
                container.appendChild(itemNameHeader);

                // テーブル要素を複製
                const table = tableTemplate.cloneNode(true);
                table.id = `dataTable-${itemName}`;
                table.style.display = "table";

                // テーブルボディを作成
                const tbody = table.querySelector("tbody");
                groupedData[itemName].forEach((row, rowIndex) => {
                    const tr = document.createElement("tr");
                    tr.style.backgroundColor = row[0] ? row[0] : '#f0f0f0'; // Set background color from the first column or default to light gray
                    tr.style.height = "30px";
                    tr.style.border = "1px solid black";

                    const imgTd = document.createElement("td");
                    imgTd.style.border = "1px solid black";
                    const img = document.createElement("img");
                    img.src = row[2];
                    img.alt = "Image";
                    img.style.maxWidth = "30px";
                    img.style.maxHeight = "30px";
                    img.onerror = function() {
                        imgTd.removeChild(img); // 画像の読み込みに失敗した場合、画像要素を削除
                    };
                    imgTd.appendChild(img);
                    tr.appendChild(imgTd);

                    columnIndices.forEach((columnIndex, index) => {
                        const td = document.createElement("td");
                        td.style.border = "1px solid black";
                        td.style.width = columnWidths[index]; // 列の幅を設定
                        td.innerText = row[columnIndex];
                        tr.appendChild(td);
                    });

                    // 行クリックイベントを追加
                    tr.addEventListener("click", function() {
                        currentRecordIndex = rowIndex;
                        currentTableName = itemName;
                        showModal(row[2], row);
                    });

                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);

                // テーブルをコンテナに追加
                container.appendChild(table);
            });
        }

        function showModal(imageSrc, rowData) {
            const modal = document.getElementById("imageModal");
            const modalImage = document.getElementById("modalImage");
            const modalInfo = document.getElementById("modalInfo");
            modal.style.display = "block";
            modalImage.src = imageSrc;

            // 全ての情報を表示（画像列を除く）
            modalInfo.innerHTML = "<h4>Information</h4>";
            columnHeaders.forEach((header, index) => {
                const indexreal = index + 3;
                const info = document.createElement("p");
                info.innerText = `${header}: ${rowData[indexreal]}`;
                modalInfo.appendChild(info);
            });
        }

        function closeModal() {
            const modal = document.getElementById("imageModal");
            modal.style.display = "none";
        }

        function showPrevRecord() {
            if (currentRecordIndex > 0) {
                currentRecordIndex--;
                const rowData = currentGroupedData[currentTableName][currentRecordIndex];
                showModal(rowData[2], rowData);
            }
        }

        function showNextRecord() {
            if (currentRecordIndex < currentGroupedData[currentTableName].length - 1) {
                currentRecordIndex++;
                const rowData = currentGroupedData[currentTableName][currentRecordIndex];
                showModal(rowData[2], rowData);
            }
        }

        async function refreshTable() {
            const newData = await fetchData();
            if (!isDataDifferent(newData, initialData)) return; // データに差異がない場合は更新しない

            const groupedData = newData.reduce((acc, row) => {
                const itemName = row[1];
                if (!acc[itemName]) {
                    acc[itemName] = [];
                }
                acc[itemName].push(row);
                return acc;
            }, {});

            createTable(groupedData); // テーブルを更新

            initialData = newData; // 更新後のデータを保存

            // モーダルが表示されている場合、現在のレコードの情報を更新
            const modal = document.getElementById("imageModal");
            if (modal.style.display === "block" && currentTableName !== null && currentRecordIndex !== null) {
                const rowData = currentGroupedData[currentTableName][currentRecordIndex];
                showModal(rowData[2], rowData);
            }
        }

        async function initializeTable() {
            tableTemplate = document.getElementById("dataTable-template"); // テーブルテンプレートを保存
            initialData = await fetchData();
            const groupedData = initialData.reduce((acc, row) => {
                const itemName = row[1];
                if (!acc[itemName]) {
                    acc[itemName] = [];
                }
                acc[itemName].push(row);
                return acc;
            }, {});

            createTable(groupedData); // テーブルを更新

            setInterval(refreshTable, 1000); // 1秒ごとにテーブルを更新
        }

        initializeTable(); // テーブルを初期化
    </script>

    <style>
        /* モーダルのスタイル */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            padding-top: 60px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.9);
        }

        /* モーダルのコンテンツ */
        .modal-content {
            margin: auto;
            display: block;
            width: 50%; /* 画像をもう少し小さく表示 */
            max-width: 500px;
        }

        /* 閉じるボタン */
        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
        }

        .close:hover,
        .close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        /* モーダル内の追加情報 */
        #modalInfo {
            color: #f1f1f1;
            text-align: center;
            margin-top: 20px;
        }

        /* 行にマウスを乗せたときのスタイル */
        tbody tr:hover {
            background-color: #e0e0e0; /* 少しグレーにする */
            cursor: pointer;
        }

        /* ヘッダ行にマウスを乗せたときのスタイルを無効にする */
        thead tr:hover {
            background-color: transparent;
            cursor: default;
        }

        /* モーダルのナビゲーションボタン */
        .modal-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: #f1f1f1;
            border: none;
            padding: 10px;
            cursor: pointer;
        }

        #prevRecord {
            left: 10px;
        }

        #nextRecord {
            right: 10px;
        }
    </style>
}